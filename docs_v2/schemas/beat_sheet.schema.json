{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://arcanomy.dev/schemas/beat_sheet.schema.json",
  "title": "BeatSheet",
  "type": "object",
  "additionalProperties": false,
  "required": ["schema_version", "run_id", "fps", "duration_seconds", "beats"],
  "properties": {
    "schema_version": { "type": "string", "const": "1.0" },
    "run_id": { "type": "string" },
    "fps": { "type": "integer", "enum": [30] },
    "duration_seconds": { "type": "number", "minimum": 5, "maximum": 90 },
    "beats": {
      "type": "array",
      "minItems": 3,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["beat_id", "t_start", "t_end", "vo_text", "caption_text", "visual_slot", "events"],
        "properties": {
          "beat_id": { "type": "string" },
          "t_start": { "type": "number", "minimum": 0 },
          "t_end": { "type": "number", "minimum": 0 },
          "vo_text": { "type": "string" },
          "caption_text": { "type": "string" },
          "caption_emphasis": {
            "type": "array",
            "description": "Words/phrases to emphasize. If timestamps are unknown at beat-sheet time, omit `t` and resolve later into emphasis.json.",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["text"],
              "properties": {
                "text": { "type": "string", "minLength": 1 },
                "t": { "type": ["number", "null"], "minimum": 0 }
              }
            }
          },
          "visual_slot": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type"],
            "properties": {
              "type": { "type": "string", "enum": ["BROLL_SLOT", "CHART_SLOT", "MATH_CARD_SLOT", "AI_SLOT"] },
              "broll": {
                "type": "object",
                "additionalProperties": false,
                "required": ["required_tags", "composition"],
                "properties": {
                  "required_tags": { "type": "array", "minItems": 1, "items": { "type": "string" } },
                  "composition": { "type": "string", "enum": ["wide", "medium", "close", "macro", "abstract"] }
                }
              },
              "chart": {
                "type": "object",
                "additionalProperties": false,
                "required": ["template", "duration_seconds"],
                "properties": {
                  "template": { "type": "string", "enum": ["single_stat", "comparison_bar", "range_bar", "timeline", "pie_simple"] },
                  "duration_seconds": { "type": "number", "minimum": 1, "maximum": 12 },
                  "props": { "type": "object", "additionalProperties": true }
                },
                "allOf": [
                  {
                    "if": { "properties": { "template": { "const": "single_stat" } } },
                    "then": {
                      "properties": {
                        "props": {
                          "type": "object",
                          "additionalProperties": true,
                          "required": ["value"],
                          "properties": {
                            "value": { "type": "number" },
                            "label": { "type": ["string", "null"] },
                            "prefix": { "type": ["string", "null"] },
                            "suffix": { "type": ["string", "null"] }
                          }
                        }
                      }
                    }
                  },
                  {
                    "if": { "properties": { "template": { "const": "comparison_bar" } } },
                    "then": {
                      "properties": {
                        "props": {
                          "type": "object",
                          "additionalProperties": true,
                          "required": ["items"],
                          "properties": {
                            "items": {
                              "type": "array",
                              "minItems": 2,
                              "maxItems": 6,
                              "items": {
                                "type": "object",
                                "additionalProperties": false,
                                "required": ["label", "value"],
                                "properties": {
                                  "label": { "type": "string" },
                                  "value": { "type": "number" },
                                  "color": { "type": ["string", "null"] }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  {
                    "if": { "properties": { "template": { "const": "range_bar" } } },
                    "then": {
                      "properties": {
                        "props": {
                          "type": "object",
                          "additionalProperties": true,
                          "required": ["min", "max"],
                          "properties": {
                            "min": { "type": "number" },
                            "max": { "type": "number" },
                            "label": { "type": ["string", "null"] }
                          }
                        }
                      }
                    }
                  },
                  {
                    "if": { "properties": { "template": { "const": "timeline" } } },
                    "then": {
                      "properties": {
                        "props": {
                          "type": "object",
                          "additionalProperties": true,
                          "required": ["points"],
                          "properties": {
                            "points": {
                              "type": "array",
                              "minItems": 2,
                              "items": {
                                "type": "object",
                                "additionalProperties": false,
                                "required": ["t", "value"],
                                "properties": {
                                  "t": { "type": "string" },
                                  "value": { "type": "number" }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  {
                    "if": { "properties": { "template": { "const": "pie_simple" } } },
                    "then": {
                      "properties": {
                        "props": {
                          "type": "object",
                          "additionalProperties": true,
                          "required": ["slices"],
                          "properties": {
                            "slices": {
                              "type": "array",
                              "minItems": 2,
                              "maxItems": 6,
                              "items": {
                                "type": "object",
                                "additionalProperties": false,
                                "required": ["label", "value"],
                                "properties": {
                                  "label": { "type": "string" },
                                  "value": { "type": "number" },
                                  "color": { "type": ["string", "null"] }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                ]
              },
              "math_card": {
                "type": "object",
                "additionalProperties": false,
                "required": ["text"],
                "properties": { "text": { "type": "string" } }
              },
              "ai": {
                "type": "object",
                "additionalProperties": false,
                "required": ["reason"],
                "properties": { "reason": { "type": "string" } }
              }
            },
            "allOf": [
              {
                "if": { "properties": { "type": { "const": "BROLL_SLOT" } } },
                "then": { "required": ["broll"] }
              },
              {
                "if": { "properties": { "type": { "const": "CHART_SLOT" } } },
                "then": { "required": ["chart"] }
              },
              {
                "if": { "properties": { "type": { "const": "MATH_CARD_SLOT" } } },
                "then": { "required": ["math_card"] }
              },
              {
                "if": { "properties": { "type": { "const": "AI_SLOT" } } },
                "then": { "required": ["ai"] }
              }
            ]
          },
          "events": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": false,
              "required": ["type", "t"],
              "properties": {
                "type": { "type": "string", "enum": ["ZOOM", "SOUND_RESET", "OVERLAY_IN", "OVERLAY_OUT"] },
                "t": { "type": "number", "minimum": 0 },
                "payload": { "type": "object", "additionalProperties": true }
              },
              "allOf": [
                {
                  "if": { "properties": { "type": { "const": "ZOOM" } } },
                  "then": {
                    "required": ["payload"],
                    "properties": {
                      "payload": {
                        "type": "object",
                        "additionalProperties": true,
                        "required": ["scale"],
                        "properties": {
                          "scale": { "type": "number", "minimum": 1.0, "maximum": 2.5 },
                          "direction": { "type": ["string", "null"], "enum": [null, "in", "out"] },
                          "easing": { "type": ["string", "null"] }
                        }
                      }
                    }
                  }
                }
              ]
            }
          }
        }
      }
    }
  }
}

